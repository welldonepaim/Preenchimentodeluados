<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Checklist Geradores — Etapas</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --txt:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.18); --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --btn:#2563eb; --btn2:#111827; --radius:18px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 800px at 20% 0%, #142347, transparent 60%),
                 radial-gradient(1000px 700px at 100% 10%, #1a2b55, transparent 55%),
                 var(--bg);
      color:var(--txt);
    }
    .app{max-width:520px;margin:0 auto; padding:12px 12px 120px}
    .top{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(to bottom, rgba(11,18,32,.95), rgba(11,18,32,.72), rgba(11,18,32,0));
      padding:10px 0 12px; backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(to bottom, rgba(15,26,46,.9), rgba(12,22,41,.88));
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    .brand h1{font-size:15px;margin:0}
    .brand .sub{font-size:11px;color:var(--muted);margin-top:2px}
    .chip{font-size:11px;color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.03)}
    .card{
      background:linear-gradient(to bottom, rgba(15,26,46,.92), rgba(12,22,41,.90));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.22);
      margin-top:12px;
    }
    h2{margin:0 0 10px;font-size:13px;color:#cbd5e1;letter-spacing:.2px}
    .hint{font-size:11px;color:var(--muted);margin-top:8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    label{font-size:11px;color:var(--muted)}
    input, select, textarea{
      width:100%; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--txt);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:360px){ .row{grid-template-columns:1fr} }

    .pill{font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px; border:1px solid transparent; white-space:nowrap}
    .pill.warn{background:rgba(245,158,11,.12); color:#fde68a; border-color:rgba(245,158,11,.22)}
    .pill.ok{background:rgba(34,197,94,.12); color:#bbf7d0; border-color:rgba(34,197,94,.22)}
    .pill.bad{background:rgba(239,68,68,.12); color:#fecaca; border-color:rgba(239,68,68,.22)}

    .stepTitle{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:6px;
    }
    .stepTitle .t{font-weight:900;font-size:13px}
    .stepTitle .s{font-size:11px;color:var(--muted);margin-top:2px}

    .req{display:none; font-size:11px; color:#fecaca; font-weight:900}
    .thumbs{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .thumb{width:120px;height:86px;border-radius:14px;border:1px solid var(--line);object-fit:cover;background:rgba(255,255,255,.02)}
    .btnRow{display:flex; gap:10px; margin-top:12px}
    .btn{
      flex:1;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      background:rgba(255,255,255,.03);
      color:var(--txt);
    }
    .btn.primary{background:linear-gradient(to bottom, rgba(37,99,235,.95), rgba(37,99,235,.75)); color:#fff; border-color:rgba(37,99,235,.35)}
    .btn.danger{background:rgba(239,68,68,.18); color:#fecaca; border-color:rgba(239,68,68,.28)}
    .btn.green{background:rgba(34,197,94,.18); color:#bbf7d0; border-color:rgba(34,197,94,.28)}
    .progress{
      margin-top:10px;
      height:10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03); overflow:hidden;
    }
    .bar{height:100%; width:0%; background:rgba(37,99,235,.55)}
    .footerBar{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:linear-gradient(to top, rgba(11,18,32,.95), rgba(11,18,32,.72), rgba(11,18,32,0));
      backdrop-filter: blur(12px);
    }
    .footerActions{max-width:520px;margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .tiny{font-size:11px;color:var(--muted);margin-top:10px}
    .logoPreview{
      width:100%; max-width:260px; height:90px;
      border:1px dashed rgba(148,163,184,.35);
      border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.02);
      overflow:hidden;
      margin-top:10px;
    }
    .logoPreview img{max-width:100%; max-height:100%; object-fit:contain}
    .miniLine{
      border-top:1px solid var(--line);
      margin:12px 0;
      opacity:.9;
    }
    .sumRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .sumRow b{font-size:12px}
    .sumRow span{font-size:11px;color:var(--muted);text-align:right}
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <div>
          <h1>Checklist Geradores</h1>
          <div class="sub">Etapas • salva no aparelho • fotos pela câmera</div>
        </div>
        <div class="chip" id="chipStatus">Rascunho</div>
      </div>

      <div class="progress" aria-label="Progresso">
        <div class="bar" id="progressBar"></div>
      </div>
      <div class="tiny" id="progressText">Etapa 1/1</div>
    </div>

    <!-- CONTEÚDO DA ETAPA -->
    <div class="card" id="stepCard">
      <!-- Preenchido via JS -->
    </div>
  </div>

  <div class="footerBar">
    <div class="footerActions">
      <button class="btn" id="btnBack">Voltar</button>
      <button class="btn primary" id="btnNext">Próximo</button>
      <button class="btn green" id="btnDoc">Documento</button>
      <button class="btn danger" id="btnClearAll">Apagar tudo</button>
    </div>
  </div>

<script>
/* =====================
   ETAPAS (wizard)
   ===================== */
// Itens por gerador conforme seu checklist
const CHECK_ITEMS = [
  { key:"oleo",     title:"Nível de Óleo", statusType:"ok_nok", photoHint:"Tire uma foto do nível de óleo" },
  { key:"baterias", title:"Carga de baterias", statusType:"ok_nok", photoHint:"Foto das baterias / carregador" },
  { key:"arref",    title:"Nível do sistema de arrefecimento", statusType:"ok_nok", photoHint:"Foto do reservatório" },
  { key:"preaq",    title:"Sistema de pré aquecimento", statusType:"funciona", photoHint:"Foto do painel / pré-aquecimento" },
];

// Monta etapas: Identificação + 4 do G1 + 4 do G2 + Revisão
const STEPS = [
  { type:"meta", title:"Identificação do documento" },
  ...CHECK_ITEMS.map(it => ({ type:"check", gen:"gerador1", ...it, stepTitle:`Gerador I • ${it.title}` })),
  ...CHECK_ITEMS.map(it => ({ type:"check", gen:"gerador2", ...it, stepTitle:`Gerador II • ${it.title}` })),
  { type:"review", title:"Revisão e salvar" }
];

/* =====================
   STORAGE
   ===================== */
const LS_STATE = "chk_wizard_state_v1";
const LS_LOGO  = "chk_wizard_logo_v1";
const LS_RECORDS = "chk_wizard_records_v1";

/* =====================
   HELPERS
   ===================== */
const $ = (id)=>document.getElementById(id);
const pad2 = (n)=>String(n).padStart(2,"0");
const nowISO = ()=>new Date().toISOString();
const ymd = (ano,mes,dia)=>`${ano}-${mes}-${pad2(dia)}`;

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

function statusOptions(type){
  if(type==="funciona"){
    return `
      <option value="">Selecione</option>
      <option value="FUNCIONANDO">Funcionando</option>
      <option value="NAO_FUNCIONANDO">Não funcionando</option>
    `;
  }
  return `
    <option value="">Selecione</option>
    <option value="OK">OK</option>
    <option value="NAO_CONFORME">Não conforme</option>
  `;
}

function pillClass(status){
  if(status==="OK"||status==="FUNCIONANDO") return "ok";
  if(status==="NAO_CONFORME"||status==="NAO_FUNCIONANDO") return "bad";
  return "warn";
}
function pillText(status){
  if(status==="OK"||status==="FUNCIONANDO") return "OK";
  if(status==="NAO_CONFORME"||status==="NAO_FUNCIONANDO") return "Não conforme";
  return "Pendente";
}

function getLogo(){ return localStorage.getItem(LS_LOGO) || ""; }
function setLogo(dataUrl){ localStorage.setItem(LS_LOGO, dataUrl || ""); }

function defaultState(){
  return {
    stepIndex: 0,
    meta: { empresa:"", mes:"", ano:"", dia:"", setor:"", responsavel:"" },
    // cada item: gerador1/2 -> oleo/baterias/arref/preaq
    geradores:{
      gerador1: {},
      gerador2: {}
    }
  };
}

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_STATE) || "null");
    return s || defaultState();
  }catch{ return defaultState(); }
}
function saveState(state){
  localStorage.setItem(LS_STATE, JSON.stringify(state));
  $("chipStatus").textContent = "Rascunho salvo";
}

function loadRecords(){
  try{return JSON.parse(localStorage.getItem(LS_RECORDS)||"[]");}catch{return[];}
}
function saveRecords(arr){
  localStorage.setItem(LS_RECORDS, JSON.stringify(arr));
}

/* =====================
   UI: Render etapa
   ===================== */
function setProgress(i){
  const total = STEPS.length;
  $("progressText").textContent = `Etapa ${i+1}/${total}`;
  $("progressBar").style.width = `${Math.round(((i+1)/total)*100)}%`;
}

function render(){
  const state = loadState();
  const step = STEPS[state.stepIndex];
  setProgress(state.stepIndex);

  const card = $("stepCard");
  card.innerHTML = "";

  // Botões
  $("btnBack").disabled = state.stepIndex === 0;
  $("btnNext").textContent = (state.stepIndex === STEPS.length - 1) ? "Salvar" : "Próximo";

  if(step.type === "meta"){
    card.innerHTML = `
      <h2>${step.title}</h2>

      <div class="field">
        <label>Empresa / Unidade</label>
        <input id="empresa" type="text" placeholder="Ex.: Hospital Geral" value="${escapeHtml(state.meta.empresa||"")}"/>
      </div>

      <div class="field">
        <label>Logo da empresa (opcional)</label>
        <input id="logoFile" type="file" accept="image/*" />
        <div class="logoPreview" id="logoPreview"></div>
        <div class="hint">O logo fica salvo no aparelho e aparece no documento.</div>
      </div>

      <div class="row">
        <div class="field">
          <label>Mês</label>
          <select id="mes">${monthOptions(state.meta.mes||"")}</select>
        </div>
        <div class="field">
          <label>Ano</label>
          <input id="ano" type="number" min="2000" max="2100" placeholder="Ex.: 2026" value="${escapeHtml(state.meta.ano||"")}"/>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Dia</label>
          <select id="dia">${dayOptions(state.meta.dia||"")}</select>
        </div>
        <div class="field">
          <label>Setor / Local</label>
          <input id="setor" type="text" placeholder="Ex.: Casa de máquinas" value="${escapeHtml(state.meta.setor||"")}"/>
        </div>
      </div>

      <div class="field">
        <label>Responsável</label>
        <input id="responsavel" type="text" placeholder="Seu nome" value="${escapeHtml(state.meta.responsavel||"")}"/>
      </div>

      <div class="hint">Na próxima etapa você preenche item por item, com foto pela câmera.</div>
    `;

    // logo preview
    renderLogoPreview(getLogo());

    // listeners
    ["input","change"].forEach(evt=>{
      ["empresa","mes","ano","dia","setor","responsavel"].forEach(id=>{
        $(id).addEventListener(evt, ()=>{
          const st = loadState();
          st.meta.empresa = $("empresa").value.trim();
          st.meta.mes = $("mes").value;
          st.meta.ano = $("ano").value;
          st.meta.dia = $("dia").value;
          st.meta.setor = $("setor").value.trim();
          st.meta.responsavel = $("responsavel").value.trim();
          saveState(st);
        });
      });
    });

    $("logoFile").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataURL(f);
      setLogo(dataUrl);
      renderLogoPreview(dataUrl);
      // salva estado pra manter “documento completo”
      saveState(loadState());
    });

    return;
  }

  if(step.type === "check"){
    const itemState = getItemState(state, step.gen, step.key);

    card.innerHTML = `
      <div class="stepTitle">
        <div>
          <div class="t">${escapeHtml(step.stepTitle || step.title)}</div>
          <div class="s">Selecione o status, preencha executor e tire foto quando necessário.</div>
        </div>
        <span class="pill ${pillClass(itemState.status)}" id="pill">${pillText(itemState.status)}</span>
      </div>

      <div class="field">
        <label>Status <span class="req" id="req">*foto obrigatória quando “Não conforme”</span></label>
        <select id="status">${statusOptions(step.statusType)}</select>
      </div>

      <div class="field">
        <label>Executor</label>
        <input id="executor" type="text" placeholder="Nome do executor" value="${escapeHtml(itemState.executor||"")}"/>
      </div>

      <div class="field">
        <label>Observação</label>
        <textarea id="obs" placeholder="Detalhes (se necessário)">${escapeHtml(itemState.observacao||"")}</textarea>
      </div>

      <div class="miniLine"></div>

      <div class="field">
        <label>${escapeHtml(step.photoHint)}</label>
        <input id="foto" type="file" accept="image/*" capture="environment" />
        <div class="thumbs" id="thumbs"></div>
        <div class="hint">No celular, isso abre a câmera (ou opção de tirar foto).</div>
      </div>
    `;

    // set status selected
    $("status").value = itemState.status || "";
    syncReqAndPill(itemState.status, itemState.fotos);

    // render thumbs
    renderThumbs(itemState.fotos || []);

    // listeners
    $("status").addEventListener("change", ()=>{
      const st = loadState();
      const it = getItemState(st, step.gen, step.key);
      it.status = $("status").value;
      setItemState(st, step.gen, step.key, it);
      saveState(st);
      syncReqAndPill(it.status, it.fotos);
    });

    ["input","change"].forEach(evt=>{
      $("executor").addEventListener(evt, ()=>{
        const st = loadState();
        const it = getItemState(st, step.gen, step.key);
        it.executor = $("executor").value.trim();
        setItemState(st, step.gen, step.key, it);
        saveState(st);
      });
      $("obs").addEventListener(evt, ()=>{
        const st = loadState();
        const it = getItemState(st, step.gen, step.key);
        it.observacao = $("obs").value.trim();
        setItemState(st, step.gen, step.key, it);
        saveState(st);
      });
    });

    $("foto").addEventListener("change", async (e)=>{
      const files = [...(e.target.files || [])];
      if(!files.length) return;
      const st = loadState();
      const it = getItemState(st, step.gen, step.key);
      it.fotos = it.fotos || [];
      for(const f of files){
        const src = await fileToDataURL(f);
        it.fotos.push(src);
      }
      setItemState(st, step.gen, step.key, it);
      saveState(st);
      renderThumbs(it.fotos);
      syncReqAndPill(it.status, it.fotos);
      // limpa input (permite tirar 2x seguidas no mesmo campo em alguns celulares)
      e.target.value = "";
    });

    return;
  }

  // REVIEW
  if(step.type === "review"){
    const payload = buildPayload(state);

    const g1 = payload.geradores.gerador1;
    const g2 = payload.geradores.gerador2;

    card.innerHTML = `
      <h2>Revisão</h2>

      <div class="sumRow"><b>Empresa</b><span>${escapeHtml(payload.empresa || "-")}</span></div>
      <div class="sumRow"><b>Data</b><span>${escapeHtml(payload.data_ref || "-")}</span></div>
      <div class="sumRow"><b>Setor</b><span>${escapeHtml(payload.setor || "-")}</span></div>
      <div class="sumRow"><b>Responsável</b><span>${escapeHtml(payload.responsavel || "-")}</span></div>

      <div class="miniLine"></div>

      <h2>Gerador I</h2>
      ${renderReviewBlock(g1)}

      <div class="miniLine"></div>

      <h2>Gerador II</h2>
      ${renderReviewBlock(g2)}

      <div class="hint">Toque em “Salvar” para gravar o registro. Você também pode gerar o documento no botão “Documento”.</div>
    `;

    return;
  }
}

function monthOptions(sel){
  const m = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  return `<option value="">Selecione</option>` + m.map(x=>`<option value="${x}" ${x===sel?"selected":""}>${x}</option>`).join("");
}
function dayOptions(sel){
  let html = `<option value="">Selecione</option>`;
  for(let i=1;i<=31;i++){
    const v = String(i);
    html += `<option value="${v}" ${v===sel?"selected":""}>${pad2(i)}</option>`;
  }
  return html;
}

function renderLogoPreview(dataUrl){
  const box = $("logoPreview");
  box.innerHTML = "";
  if(!dataUrl){
    box.innerHTML = `<span class="hint">Nenhum logo selecionado</span>`;
    return;
  }
  const img = document.createElement("img");
  img.src = dataUrl;
  img.alt = "Logo";
  box.appendChild(img);
}

function renderThumbs(fotos){
  const thumbs = $("thumbs");
  thumbs.innerHTML = "";
  (fotos || []).slice(0,10).forEach((src, idx)=>{
    const img = document.createElement("img");
    img.src = src;
    img.className = "thumb";
    img.alt = "Foto " + (idx+1);
    thumbs.appendChild(img);
  });
}

function syncReqAndPill(status, fotos){
  const needsPhoto = (status==="NAO_CONFORME" || status==="NAO_FUNCIONANDO");
  const hasPhoto = (fotos || []).length > 0;
  const req = $("req");
  const pill = $("pill");
  if(req) req.style.display = needsPhoto ? "inline" : "none";
  if(pill){
    pill.className = `pill ${pillClass(status)}`;
    pill.textContent = pillText(status);
    // se precisa foto e não tem, deixa pill vermelha pra alertar
    if(needsPhoto && !hasPhoto){
      pill.className = "pill bad";
      pill.textContent = "Falta foto";
    }
  }
}

/* =====================
   Estado item por item
   ===================== */
function getItemState(state, gen, key){
  state.geradores[gen] = state.geradores[gen] || {};
  state.geradores[gen][key] = state.geradores[gen][key] || { status:"", executor:"", observacao:"", fotos:[] };
  return state.geradores[gen][key];
}
function setItemState(state, gen, key, val){
  state.geradores[gen] = state.geradores[gen] || {};
  state.geradores[gen][key] = val;
}

/* =====================
   Payload final + validação
   ===================== */
function buildPayload(state){
  const mes = state.meta.mes, ano = state.meta.ano, dia = state.meta.dia;
  return {
    schema:"chk_geradores_wizard_v1",
    created_at: nowISO(),
    empresa: state.meta.empresa,
    logo: getLogo(),
    mes, ano, dia,
    data_ref: (mes && ano && dia) ? ymd(ano, mes, Number(dia)) : "",
    setor: state.meta.setor,
    responsavel: state.meta.responsavel,
    geradores: state.geradores
  };
}

function validateForStep(stepIndex){
  const state = loadState();
  const step = STEPS[stepIndex];

  // valida meta antes de avançar
  if(step.type === "meta"){
    const errs=[];
    if(!state.meta.mes) errs.push("Selecione o mês.");
    if(!state.meta.ano) errs.push("Informe o ano.");
    if(!state.meta.dia) errs.push("Selecione o dia.");
    if(!state.meta.setor) errs.push("Informe o setor/local.");
    if(!state.meta.responsavel) errs.push("Informe o responsável.");
    if(errs.length) return errs;
    return [];
  }

  // valida cada item: se não conforme -> precisa foto
  if(step.type === "check"){
    const it = getItemState(state, step.gen, step.key);
    const errs=[];
    if(!it.status) errs.push("Selecione o status.");
    const needsPhoto = (it.status==="NAO_CONFORME" || it.status==="NAO_FUNCIONANDO");
    if(needsPhoto && (!it.fotos || it.fotos.length===0)) errs.push("Foto obrigatória para Não conforme.");
    return errs;
  }

  // valida final
  if(step.type === "review"){
    // aqui pode ser mais rígido (ex: todos os status preenchidos)
    const payload = buildPayload(state);
    const errs=[];
    // garante todos status preenchidos
    ["gerador1","gerador2"].forEach(g=>{
      CHECK_ITEMS.forEach(it=>{
        const v = payload.geradores[g]?.[it.key]?.status;
        if(!v) errs.push(`${g.toUpperCase()} → ${it.title}: selecione o status.`);
        const needsPhoto = (v==="NAO_CONFORME" || v==="NAO_FUNCIONANDO");
        const fotos = payload.geradores[g]?.[it.key]?.fotos || [];
        if(needsPhoto && fotos.length===0) errs.push(`${g.toUpperCase()} → ${it.title}: falta foto.`);
      });
    });
    return errs;
  }

  return [];
}

function saveAsRecord(){
  const state = loadState();
  const payload = buildPayload(state);

  const key = payload.data_ref || ("sem-data-" + Date.now());
  const records = loadRecords();
  const idx = records.findIndex(r => r.data_ref === key);
  if(idx>=0){
    const created_at = records[idx].created_at || payload.created_at;
    records[idx] = { ...payload, created_at, updated_at: nowISO() };
  } else {
    records.unshift({ ...payload, updated_at: nowISO() });
  }
  saveRecords(records);
  $("chipStatus").textContent = "Salvo ✅";
}

/* =====================
   Documento padrão (print/PDF)
   ===================== */
function statusLabel(st){
  if(st==="OK"||st==="FUNCIONANDO") return "OK";
  if(st==="NAO_CONFORME") return "NÃO CONFORME";
  if(st==="NAO_FUNCIONANDO") return "NÃO FUNCIONANDO";
  return "—";
}
function openDocument(payload){
  const w = window.open("", "_blank");
  const logo = payload.logo || "";
  const title = "Documento - Checklist dos Geradores";

  const rowsFor = (gKey) => {
    const g = payload.geradores[gKey] || {};
    return CHECK_ITEMS.map(it=>{
      const item = g[it.key] || {};
      const fotos = (item.fotos || []).slice(0,6).map(src=>`<img class="pimg" src="${src}" alt="Foto"/>`).join("");
      return `
        <tr>
          <td class="colItem">${it.title}</td>
          <td class="colStatus">${statusLabel(item.status)}</td>
          <td class="colExec">${escapeHtml(item.executor || "")}</td>
          <td class="colObs">${escapeHtml(item.observacao || "")}</td>
          <td class="colFoto">${fotos || "<span class='muted'>—</span>"}</td>
        </tr>
      `;
    }).join("");
  };

  w.document.open();
  w.document.write(`
<!DOCTYPE html><html lang="pt-BR"><head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title}</title>
<style>
  :root{--txt:#111827;--muted:#6b7280;--line:#e5e7eb}
  body{font-family:Arial, Helvetica, sans-serif; color:var(--txt); margin:18px}
  .hdr{display:flex; gap:14px; align-items:center; border-bottom:2px solid var(--line); padding-bottom:10px}
  .logo{width:140px; height:70px; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; overflow:hidden}
  .logo img{max-width:100%; max-height:100%; object-fit:contain}
  .hinfo{flex:1}
  .hinfo h1{margin:0; font-size:16px}
  .hinfo .sub{margin-top:4px; font-size:12px; color:var(--muted)}
  .meta{margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px}
  .meta div{padding:8px; border:1px solid var(--line); border-radius:10px}
  h2{font-size:13px; margin:16px 0 8px}
  table{width:100%; border-collapse:collapse; font-size:12px}
  th,td{border:1px solid var(--line); padding:8px; vertical-align:top}
  th{background:#f9fafb; text-align:left}
  .muted{color:var(--muted)}
  .pimg{width:92px;height:64px; object-fit:cover; border:1px solid var(--line); border-radius:8px; margin:2px}
  .colItem{width:20%}.colStatus{width:12%}.colExec{width:16%}.colObs{width:28%}.colFoto{width:24%}
  .sign{margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:12px}
  .box{border:1px solid var(--line); border-radius:10px; padding:12px; height:70px}
  @media print{ body{margin:10mm} }
</style>
</head><body>
  <div class="hdr">
    <div class="logo">${logo ? `<img src="${logo}" alt="Logo"/>` : `<span class="muted">Logo</span>`}</div>
    <div class="hinfo">
      <h1>${escapeHtml(payload.empresa || "Empresa / Unidade")}</h1>
      <div class="sub"><b>Checklist dos Geradores</b> • Documento padrão</div>
      <div class="sub muted">Gerado em: ${new Date().toLocaleString()}</div>
    </div>
  </div>

  <div class="meta">
    <div><b>Data (ref)</b><br>${escapeHtml(payload.data_ref || "-")}</div>
    <div><b>Setor / Local</b><br>${escapeHtml(payload.setor || "-")}</div>
    <div><b>Responsável</b><br>${escapeHtml(payload.responsavel || "-")}</div>
    <div><b>Mês/Ano</b><br>${escapeHtml(payload.mes || "-")}/${escapeHtml(payload.ano || "-")}</div>
  </div>

  <h2>Gerador I</h2>
  <table><thead><tr><th>Item</th><th>Status</th><th>Executor</th><th>Observação</th><th>Fotos</th></tr></thead>
  <tbody>${rowsFor("gerador1")}</tbody></table>

  <h2>Gerador II</h2>
  <table><thead><tr><th>Item</th><th>Status</th><th>Executor</th><th>Observação</th><th>Fotos</th></tr></thead>
  <tbody>${rowsFor("gerador2")}</tbody></table>

  <div class="sign">
    <div class="box"><b>Assinatura / Executor</b><br><span class="muted">________________________________________</span></div>
    <div class="box"><b>Assinatura / Verificador</b><br><span class="muted">________________________________________</span></div>
  </div>
</body></html>`);
  w.document.close();
}

/* =====================
   Review bloco
   ===================== */
function renderReviewBlock(g){
  return CHECK_ITEMS.map(it=>{
    const item = (g && g[it.key]) ? g[it.key] : {};
    const st = item.status || "";
    const fotos = (item.fotos||[]).length;
    const pill = `<span class="pill ${pillClass(st)}">${escapeHtml(pillText(st))}</span>`;
    return `
      <div class="sumRow" style="margin-top:10px">
        <b>${escapeHtml(it.title)}</b>
        <span>${pill} • fotos: ${fotos}</span>
      </div>
    `;
  }).join("");
}

/* =====================
   Navegação
   ===================== */
function go(delta){
  const state = loadState();
  const next = state.stepIndex + delta;
  if(next < 0 || next >= STEPS.length) return;

  // valida etapa atual antes de avançar
  if(delta > 0){
    const errs = validateForStep(state.stepIndex);
    if(errs.length){
      alert("Corrija antes de continuar:\n\n- " + errs.join("\n- "));
      return;
    }
  }

  state.stepIndex = next;
  saveState(state);
  render();
}

function finishSave(){
  const errs = validateForStep(STEPS.length - 1);
  if(errs.length){
    alert("Corrija antes de salvar:\n\n- " + errs.join("\n- "));
    return;
  }
  saveAsRecord();
  alert("Registro salvo!");
}

/* =====================
   INIT
   ===================== */
(function init(){
  // primeira renderização
  render();

  $("btnBack").addEventListener("click", ()=>go(-1));
  $("btnNext").addEventListener("click", ()=>{
    const state = loadState();
    if(state.stepIndex === STEPS.length - 1){
      finishSave();
    } else {
      go(1);
    }
  });

  $("btnDoc").addEventListener("click", ()=>{
    const payload = buildPayload(loadState());
    // aqui a gente não bloqueia (mas se quiser, valida tudo)
    openDocument(payload);
  });

  $("btnClearAll").addEventListener("click", ()=>{
    if(!confirm("Apagar tudo (logo + rascunho + registros) do aparelho?")) return;
    localStorage.removeItem(LS_LOGO);
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_RECORDS);
    location.reload();
  });
})();
</script>
</body>
</html>
